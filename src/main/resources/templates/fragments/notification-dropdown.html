<!-- Notification Dropdown -->
<div th:fragment="notification-dropdown" class="dropdown" sec:authorize="isAuthenticated()">
    <a class="nav-link dropdown-toggle position-relative" href="#" id="notificationDropdown" role="button"
       data-bs-toggle="dropdown" data-bs-auto-close="outside" aria-expanded="false">
        <i class="bi bi-bell"></i> Thông báo
        <span id="notification-badge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
              style="display: none;">0</span>
    </a>

    <ul class="dropdown-menu dropdown-menu-end notification-dropdown-menu" style="width: 350px; max-height: 400px; overflow-y: auto;"
        aria-labelledby="notificationDropdown">
        <li class="dropdown-header">
            <div class="d-flex justify-content-between align-items-center">
                <span><i class="bi bi-bell"></i> Thông báo</span>
                <a href="/notifications" class="text-decoration-none">Xem tất cả</a>
            </div>
        </li>
        <li><hr class="dropdown-divider"></li>

        <li id="notification-loading" class="text-center p-3">
            <div class="spinner-border spinner-border-sm" role="status">
                <span class="visually-hidden">Đang tải...</span>
            </div>
            <div class="mt-2 text-muted">Đang tải thông báo...</div>
        </li>

        <li id="notification-empty" class="text-center p-3" style="display: none;">
            <i class="bi bi-bell-slash text-muted" style="font-size: 2rem;"></i>
            <div class="mt-2 text-muted">Không có thông báo mới</div>
        </li>

        <ul id="notification-list" class="list-unstyled mb-0" style="display: none;">
            <!-- Notifications will be loaded here via JavaScript -->
        </ul>

        <li><hr class="dropdown-divider"></li>
        <li>
            <div class="d-grid p-2">
                <form action="/notifications/mark-all-read" method="post" class="d-inline">
                    <button type="submit" class="btn btn-sm btn-outline-primary w-100">
                        <i class="bi bi-check-all"></i> Đánh dấu tất cả đã đọc
                    </button>
                </form>
            </div>
        </li>
    </ul>
</div>

<!-- Notification Dropdown JavaScript -->
<script th:fragment="notification-script">
    document.addEventListener('DOMContentLoaded', function() {
        const notificationBadge = document.getElementById('notification-badge');
        const notificationList = document.getElementById('notification-list');
        const notificationLoading = document.getElementById('notification-loading');
        const notificationEmpty = document.getElementById('notification-empty');

        // Load notifications when dropdown is shown
        const notificationDropdown = document.getElementById('notificationDropdown');
        if (notificationDropdown) {
            notificationDropdown.addEventListener('shown.bs.dropdown', function() {
                loadNotifications();
            });

            // Also update badge periodically
            updateNotificationBadge();
            setInterval(updateNotificationBadge, 30000);
        }

        function updateNotificationBadge() {
            fetch('/notifications/api/unread-count')
                .then(response => response.json())
                .then(data => {
                    if (data.success && notificationBadge) {
                        if (data.count > 0) {
                            notificationBadge.textContent = data.count > 99 ? '99+' : data.count;
                            notificationBadge.style.display = 'inline-block';
                        } else {
                            notificationBadge.style.display = 'none';
                        }
                    }
                })
                .catch(error => console.error('Error updating notification badge:', error));
        }

        function loadNotifications() {
            if (notificationLoading) {
                notificationLoading.style.display = 'block';
            }
            if (notificationList) {
                notificationList.style.display = 'none';
            }
            if (notificationEmpty) {
                notificationEmpty.style.display = 'none';
            }

            fetch('/notifications/api/recent')
                .then(response => response.json())
                .then(data => {
                    if (notificationLoading) {
                        notificationLoading.style.display = 'none';
                    }

                    if (data.length === 0) {
                        if (notificationEmpty) {
                            notificationEmpty.style.display = 'block';
                        }
                    } else {
                        renderNotifications(data);
                    }
                })
                .catch(error => {
                    console.error('Error loading notifications:', error);
                    if (notificationLoading) {
                        notificationLoading.style.display = 'none';
                    }
                    if (notificationEmpty) {
                        notificationEmpty.innerHTML = '<i class="bi bi-exclamation-triangle text-danger"></i><div class="mt-2 text-danger">Lỗi tải thông báo</div>';
                        notificationEmpty.style.display = 'block';
                    }
                });
        }

        function renderNotifications(notifications) {
            if (!notificationList) return;

            notificationList.innerHTML = '';

            notifications.forEach(notification => {
                const li = document.createElement('li');
                li.className = 'notification-item p-2 border-bottom';

                const typeClass = getTypeClass(notification.type);
                const typeIcon = getTypeIcon(notification.type);

                li.innerHTML = `
                    <div class="d-flex">
                        <div class="flex-shrink-0">
                            <div class="notification-icon-sm ${typeClass}">
                                <i class="bi ${typeIcon}"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-2">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1 ${!notification.isRead ? 'fw-bold' : ''}"
                                        style="font-size: 0.875rem;">
                                        ${notification.title || 'Thông báo'}
                                    </h6>
                                    <p class="mb-1 text-truncate" style="font-size: 0.8rem;" title="${notification.message}">
                                        ${notification.message}
                                    </p>
                                    <small class="text-muted">
                                        <i class="bi bi-clock"></i>
                                        ${formatTime(notification.createdAt)}
                                    </small>
                                </div>
                                ${!notification.isRead ? '<div class="flex-shrink-0 ms-2"><span class="badge bg-primary">Mới</span></div>' : ''}
                            </div>
                            ${notification.actionUrl ? `
                                <div class="mt-1">
                                    <a href="${notification.actionUrl}" class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-arrow-right"></i> Xem
                                    </a>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;

                // Add click handler to mark as read and navigate
                if (notification.actionUrl) {
                    const actionLink = li.querySelector(`a[href="${notification.actionUrl}"]`);
                    if (actionLink) {
                        actionLink.addEventListener('click', function(e) {
                            e.preventDefault();
                            markAsReadAndNavigate(notification.id, notification.actionUrl);
                        });
                    }
                } else {
                    // Make the whole item clickable to mark as read if no action URL
                    li.style.cursor = 'pointer';
                    li.addEventListener('click', function() {
                        markAsRead(notification.id);
                    });
                }

                notificationList.appendChild(li);
            });

            notificationList.style.display = 'block';
        }

        function markAsRead(notificationId) {
            fetch(`/notifications/mark-read/${notificationId}`, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (response.ok) {
                    // Reload notifications and update badge
                    loadNotifications();
                    updateNotificationBadge();
                }
            })
            .catch(error => console.error('Error marking notification as read:', error));
        }

        function markAsReadAndNavigate(notificationId, actionUrl) {
            fetch(`/notifications/mark-read/${notificationId}`, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (response.ok) {
                    // Update badge and navigate
                    updateNotificationBadge();
                    window.location.href = actionUrl;
                }
            })
            .catch(error => {
                console.error('Error marking notification as read:', error);
                // Fallback to navigation
                window.location.href = actionUrl;
            });
        }

        function getTypeClass(type) {
            switch (type) {
                case 'SUCCESS': return 'text-success';
                case 'WARNING': return 'text-warning';
                case 'ERROR': return 'text-danger';
                case 'GOAL': return 'text-info';
                case 'BUDGET': return 'text-primary';
                case 'TRANSACTION': return 'text-secondary';
                case 'SYSTEM': return 'text-dark';
                default: return 'text-secondary';
            }
        }

        function getTypeIcon(type) {
            switch (type) {
                case 'SUCCESS': return 'bi-check-circle-fill';
                case 'WARNING': return 'bi-exclamation-triangle-fill';
                case 'ERROR': return 'bi-x-circle-fill';
                case 'GOAL': return 'bi-trophy-fill';
                case 'BUDGET': return 'bi-piggy-bank-fill';
                case 'TRANSACTION': return 'bi-arrow-left-right-fill';
                case 'SYSTEM': return 'bi-gear-fill';
                default: return 'bi-info-circle-fill';
            }
        }

        function formatTime(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Vừa xong';
            if (diffMins < 60) return `${diffMins} phút trước`;
            if (diffHours < 24) return `${diffHours} giờ trước`;
            if (diffDays < 7) return `${diffDays} ngày trước`;

            return date.toLocaleDateString('vi-VN');
        }
    });
</script>

<style>
    .notification-icon-sm {
        font-size: 1.2rem;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background-color: rgba(0,0,0,0.1);
    }

    .notification-item {
        transition: background-color 0.2s ease;
        cursor: pointer;
    }

    .notification-item:hover {
        background-color: rgba(0,0,0,0.05);
    }

    .notification-item:last-child {
        border-bottom: none !important;
    }

    .dropdown-menu {
        animation: fadeIn 0.2s ease-in;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .text-truncate {
        max-width: 200px;
    }
</style>